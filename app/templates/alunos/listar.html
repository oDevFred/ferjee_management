{% extends "base.html" %}

{% block title %}Listar Alunos - FERJEE{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Lista de Alunos</h2>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#novoAlunoModal">
            <i class="fas fa-plus"></i> Novo Aluno
        </button>
    </div>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    {% if alunos %}
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Matr√≠cula</th>
                        <th>Nome</th>
                        <th>CPF</th>
                        <th>Email</th>
                        <th>Telefone</th>
                        <th>Cidade/UF</th>
                        <th>Status</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for aluno in alunos %}
                    <tr>
                        <td><strong>{{ aluno.matricula }}</strong></td>
                        <td>{{ aluno.nome }}</td>
                        <td>{{ aluno.cpf }}</td>
                        <td>{{ aluno.email }}</td>
                        <td>{{ aluno.telefone }}</td>
                        <td>{{ aluno.cidade }}/{{ aluno.estado }}</td>
                        <td>
                            {% if aluno.ativo %}
                                <span class="badge bg-success">Ativo</span>
                            {% else %}
                                <span class="badge bg-danger">Inativo</span>
                            {% endif %}
                        </td>
                        <td>
                            <button type="button" class="btn btn-sm btn-warning" onclick="abrirModalEditar({{ aluno.id }})" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-danger" onclick="abrirModalExcluir({{ aluno.id }})" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-info" onclick="verMatriculas({{ aluno.id }})" title="Ver Matr√≠culas">
                                <i class="fas fa-clipboard-list"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="alert alert-info text-center">
            <i class="fas fa-info-circle"></i> Nenhum aluno cadastrado no sistema.
        </div>
    {% endif %}
</div>

<!-- Modal Novo Aluno -->
<div class="modal fade" id="novoAlunoModal" tabindex="-1" aria-labelledby="novoAlunoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="novoAlunoModalLabel">
                    <i class="fas fa-user-plus"></i> Novo Aluno
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formNovoAluno" method="POST">
                    {{ form_novo.hidden_tag() }}
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form_novo.nome.label(class="form-label") }}
                                {{ form_novo.nome(class="form-control") }}
                                <div class="text-danger" id="erro-nome"></div>
                            </div>
                            
                            <div class="mb-3">
                                {{ form_novo.rg.label(class="form-label") }}
                                {{ form_novo.rg(class="form-control") }}
                                <div class="text-danger" id="erro-rg"></div>
                            </div>
                            
                            <div class="mb-3">
                                {{ form_novo.cpf.label(class="form-label") }}
                                {{ form_novo.cpf(class="form-control", id="cpf-input") }}
                                <div class="text-danger" id="erro-cpf"></div>
                                <small class="text-muted" id="cpf-validacao"></small>
                            </div>
                            
                            <div class="mb-3">
                                {{ form_novo.data_nascimento.label(class="form-label") }}
                                {{ form_novo.data_nascimento(class="form-control") }}
                                <div class="text-danger" id="erro-data_nascimento"></div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form_novo.email.label(class="form-label") }}
                                {{ form_novo.email(class="form-control") }}
                                <div class="text-danger" id="erro-email"></div>
                            </div>
                            
                            <div class="mb-3">
                                {{ form_novo.telefone.label(class="form-label") }}
                                {{ form_novo.telefone(class="form-control") }}
                                <div class="text-danger" id="erro-telefone"></div>
                            </div>
                            
                            <div class="mb-3">
                                {{ form_novo.endereco.label(class="form-label") }}
                                {{ form_novo.endereco(class="form-control") }}
                                <div class="text-danger" id="erro-endereco"></div>
                            </div>
                            
                            <div class="mb-3">
                                {{ form_novo.bairro.label(class="form-label") }}
                                {{ form_novo.bairro(class="form-control") }}
                                <div class="text-danger" id="erro-bairro"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form_novo.cidade.label(class="form-label") }}
                                {{ form_novo.cidade(class="form-control") }}
                                <div class="text-danger" id="erro-cidade"></div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="mb-3">
                                {{ form_novo.estado.label(class="form-label") }}
                                {{ form_novo.estado(class="form-control") }}
                                <div class="text-danger" id="erro-estado"></div>
                            </div>
                        </div>
                        
                        <div class="col-md-2">
                            <div class="mb-3 form-check mt-4">
                                {{ form_novo.ativo(class="form-check-input") }}
                                {{ form_novo.ativo.label(class="form-check-label") }}
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="salvarNovoAluno()">
                    <i class="fas fa-save"></i> Salvar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Editar Aluno -->
<div class="modal fade" id="editarAlunoModal" tabindex="-1" aria-labelledby="editarAlunoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editarAlunoModalLabel">
                    <i class="fas fa-user-edit"></i> Editar Aluno
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formEditarAluno" method="POST">
                    <input type="hidden" id="editar-aluno-id" name="id">
                    <input type="hidden" name="csrf_token" value="{{ form_novo.csrf_token._value() }}">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Nome Completo</label>
                                <input type="text" class="form-control" id="editar-nome" name="nome" required>
                                <div class="text-danger" id="editar-erro-nome"></div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">RG</label>
                                <input type="text" class="form-control" id="editar-rg" name="rg">
                                <div class="text-danger" id="editar-erro-rg"></div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">CPF</label>
                                <input type="text" class="form-control" id="editar-cpf" name="cpf">
                                <div class="text-danger" id="editar-erro-cpf"></div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Data de Nascimento</label>
                                <input type="date" class="form-control" id="editar-data_nascimento" name="data_nascimento">
                                <div class="text-danger" id="editar-erro-data_nascimento"></div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">E-mail</label>
                                <input type="email" class="form-control" id="editar-email" name="email">
                                <div class="text-danger" id="editar-erro-email"></div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Telefone</label>
                                <input type="text" class="form-control" id="editar-telefone" name="telefone">
                                <div class="text-danger" id="editar-erro-telefone"></div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Endere√ßo</label>
                                <input type="text" class="form-control" id="editar-endereco" name="endereco">
                                <div class="text-danger" id="editar-erro-endereco"></div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Bairro</label>
                                <input type="text" class="form-control" id="editar-bairro" name="bairro">
                                <div class="text-danger" id="editar-erro-bairro"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Cidade</label>
                                <input type="text" class="form-control" id="editar-cidade" name="cidade">
                                <div class="text-danger" id="editar-erro-cidade"></div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Estado</label>
                                <select class="form-control" id="editar-estado" name="estado">
                                    <option value="">Selecione...</option>
                                    <option value="AC">Acre</option>
                                    <option value="AL">Alagoas</option>
                                    <option value="AP">Amap√°</option>
                                    <option value="AM">Amazonas</option>
                                    <option value="BA">Bahia</option>
                                    <option value="CE">Cear√°</option>
                                    <option value="DF">Distrito Federal</option>
                                    <option value="ES">Esp√≠rito Santo</option>
                                    <option value="GO">Goi√°s</option>
                                    <option value="MA">Maranh√£o</option>
                                    <option value="MT">Mato Grosso</option>
                                    <option value="MS">Mato Grosso do Sul</option>
                                    <option value="MG">Minas Gerais</option>
                                    <option value="PA">Par√°</option>
                                    <option value="PB">Para√≠ba</option>
                                    <option value="PR">Paran√°</option>
                                    <option value="PE">Pernambuco</option>
                                    <option value="PI">Piau√≠</option>
                                    <option value="RJ">Rio de Janeiro</option>
                                    <option value="RN">Rio Grande do Norte</option>
                                    <option value="RS">Rio Grande do Sul</option>
                                    <option value="RO">Rond√¥nia</option>
                                    <option value="RR">Roraima</option>
                                    <option value="SC">Santa Catarina</option>
                                    <option value="SP">S√£o Paulo</option>
                                    <option value="SE">Sergipe</option>
                                    <option value="TO">Tocantins</option>
                                </select>
                                <div class="text-danger" id="editar-erro-estado"></div>
                            </div>
                        </div>
                        
                        <div class="col-md-2">
                            <div class="mb-3 form-check mt-4">
                                <input type="checkbox" class="form-check-input" id="editar-ativo" name="ativo">
                                <label class="form-check-label" for="editar-ativo">Ativo</label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="salvarEdicaoAluno()">
                    <i class="fas fa-save"></i> Salvar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Excluir Aluno -->
<div class="modal fade" id="excluirAlunoModal" tabindex="-1" aria-labelledby="excluirAlunoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="excluirAlunoModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> Confirmar Exclus√£o
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir o aluno abaixo?</p>
                
                <div class="alert alert-warning">
                    <h5 id="excluir-aluno-nome"></h5>
                    <p class="mb-0">
                        <strong>Matr√≠cula:</strong> <span id="excluir-aluno-matricula"></span><br>
                        <strong>CPF:</strong> <span id="excluir-aluno-cpf"></span><br>
                        <strong>Email:</strong> <span id="excluir-aluno-email"></span>
                    </p>
                </div>
                
                <p class="text-danger">
                    <strong>Aten√ß√£o:</strong> Esta a√ß√£o n√£o pode ser desfeita!
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-danger" onclick="confirmarExclusaoAluno()">
                    <i class="fas fa-trash"></i> Confirmar Exclus√£o
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Matr√≠culas do Aluno -->
<div class="modal fade" id="matriculasAlunoModal" tabindex="-1" aria-labelledby="matriculasAlunoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="matriculasAlunoModalLabel">
                    <i class="fas fa-clipboard-list"></i> Matr√≠culas do Aluno
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="matriculas-list"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script>
let alunoIdParaExcluir = null;

// Fun√ß√£o para validar CPF
function validarCPF(cpf) {
    // Remover caracteres n√£o num√©ricos
    cpf = cpf.replace(/\D/g, '');
    
    if (cpf.length !== 11) {
        return false;
    }
    
    // Verificar se todos os d√≠gitos s√£o iguais
    if (/^(\d)\1{10}$/.test(cpf)) {
        return false;
    }
    
    // C√°lculo do primeiro d√≠gito verificador
    let soma = 0;
    for (let i = 0; i < 9; i++) {
        soma += parseInt(cpf[i]) * (10 - i);
    }
    let resto = 11 - (soma % 11);
    let digito1 = resto === 10 || resto === 11 ? 0 : resto;
    
    // C√°lculo do segundo d√≠gito verificador
    soma = 0;
    for (let i = 0; i < 10; i++) {
        soma += parseInt(cpf[i]) * (11 - i);
    }
    resto = 11 - (soma % 11);
    let digito2 = resto === 10 || resto === 11 ? 0 : resto;
    
    // Verificar se os d√≠gitos verificadores est√£o corretos
    return parseInt(cpf[9]) === digito1 && parseInt(cpf[10]) === digito2;
}

// Formatar CPF enquanto digita
function formatarCPF(cpf) {
    cpf = cpf.replace(/\D/g, '');
    cpf = cpf.replace(/(\d{3})(\d)/, '$1.$2');
    cpf = cpf.replace(/(\d{3})(\d)/, '$1.$2');
    cpf = cpf.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
    return cpf;
}

// Adicionar evento de input ao campo CPF
document.addEventListener('DOMContentLoaded', function() {
    const cpfInput = document.getElementById('cpf-input');
    const cpfValidacao = document.getElementById('cpf-validacao');
    
    if (cpfInput) {
        cpfInput.addEventListener('input', function(e) {
            let valor = e.target.value;
            
            // Formatar CPF
            e.target.value = formatarCPF(valor);
            
            // Validar CPF
            if (valor.length >= 11) {
                if (validarCPF(valor)) {
                    cpfValidacao.textContent = '‚úÖ CPF v√°lido';
                    cpfValidacao.className = 'text-success';
                } else {
                    cpfValidacao.textContent = '‚ùå CPF inv√°lido';
                    cpfValidacao.className = 'text-danger';
                }
            } else {
                cpfValidacao.textContent = '';
            }
        });
    }
});

function abrirModalEditar(id) {
    console.log(`üìù Abrindo modal de edi√ß√£o para o aluno ID: ${id}`);
    
    // Buscar dados do aluno via AJAX
    fetch(`/alunos/${id}/dados`)
        .then(response => response.json())
        .then(data => {
            // Preencher o formul√°rio com os dados do aluno
            document.getElementById('editar-aluno-id').value = data.id;
            document.getElementById('editar-nome').value = data.nome;
            document.getElementById('editar-rg').value = data.rg || '';
            document.getElementById('editar-cpf').value = data.cpf || '';
            document.getElementById('editar-data_nascimento').value = data.data_nascimento || '';
            document.getElementById('editar-email').value = data.email || '';
            document.getElementById('editar-telefone').value = data.telefone || '';
            document.getElementById('editar-endereco').value = data.endereco || '';
            document.getElementById('editar-bairro').value = data.bairro || '';
            document.getElementById('editar-cidade').value = data.cidade || '';
            document.getElementById('editar-estado').value = data.estado || '';
            document.getElementById('editar-cep').value = data.cep || '';
            document.getElementById('editar-ativo').checked = data.ativo;
            
            // Abrir o modal
            const modal = new bootstrap.Modal(document.getElementById('editarAlunoModal'));
            modal.show();
        })
        .catch(error => {
            console.error('‚ùå Erro ao buscar dados do aluno:', error);
            alert('Erro ao carregar dados do aluno.');
        });
}

function abrirModalExcluir(id) {
    console.log(`üóëÔ∏è Abrindo modal de exclus√£o para o aluno ID: ${id}`);
    
    // Buscar dados do aluno via AJAX
    fetch(`/alunos/${id}/dados`)
        .then(response => response.json())
        .then(data => {
            // Preencher os dados do aluno no modal
            document.getElementById('excluir-aluno-nome').textContent = data.nome;
            document.getElementById('excluir-aluno-matricula').textContent = data.matricula;
            document.getElementById('excluir-aluno-cpf').textContent = data.cpf || 'N√£o informado';
            document.getElementById('excluir-aluno-email').textContent = data.email || 'N√£o informado';
            
            // Armazenar o ID do aluno para exclus√£o
            alunoIdParaExcluir = id;
            
            // Abrir o modal
            const modal = new bootstrap.Modal(document.getElementById('excluirAlunoModal'));
            modal.show();
        })
        .catch(error => {
            console.error('‚ùå Erro ao buscar dados do aluno:', error);
            alert('Erro ao carregar dados do aluno.');
        });
}

function verMatriculas(id) {
    console.log(`üìù Visualizando matr√≠culas do aluno ID: ${id}`);
    
    // Buscar matr√≠culas do aluno via AJAX
    fetch(`/alunos/${id}/matriculas`)
        .then(response => response.json())
        .then(data => {
            let html = '';
            
            if (data.matriculas.length > 0) {
                html = `
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Curso</th>
                                <th>Data da Matr√≠cula</th>
                                <th>Status</th>
                                <th>Observa√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                data.matriculas.forEach(matricula => {
                    html += `
                        <tr>
                            <td>${matricula.curso_nome}</td>
                            <td>${new Date(matricula.data_matricula).toLocaleDateString('pt-BR')}</td>
                            <td>
                                <span class="badge bg-${getStatusColor(matricula.status)}">${matricula.status}</span>
                            </td>
                            <td>${matricula.observacoes || '-'}</td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
            } else {
                html = '<p class="text-muted">Este aluno n√£o possui matr√≠culas.</p>';
            }
            
            document.getElementById('matriculas-list').innerHTML = html;
            
            // Abrir o modal
            const modal = new bootstrap.Modal(document.getElementById('matriculasAlunoModal'));
            modal.show();
        })
        .catch(error => {
            console.error('‚ùå Erro ao buscar matr√≠culas do aluno:', error);
            alert('Erro ao carregar matr√≠culas do aluno.');
        });
}

function getStatusColor(status) {
    const colors = {
        'ativo': 'success',
        'concluido': 'primary',
        'cancelado': 'danger',
        'trancado': 'warning'
    };
    return colors[status] || 'secondary';
}

function salvarNovoAluno() {
    console.log('üíæ Salvando novo aluno...');
    
    const form = document.getElementById('formNovoAluno');
    const formData = new FormData(form);
    
    fetch('/alunos/novo', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.redirected) {
            window.location.href = response.url;
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Fechar o modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('novoAlunoModal'));
            modal.hide();
            
            // Mostrar mensagem com a matr√≠cula gerada
            alert(`Aluno cadastrado com sucesso!\nMatr√≠cula: ${data.matricula}`);
            
            // Recarregar a p√°gina
            window.location.reload();
        } else {
            // Exibir erros de valida√ß√£o
            if (data.errors) {
                for (const [field, errors] of Object.entries(data.errors)) {
                    const errorDiv = document.getElementById(`erro-${field}`);
                    if (errorDiv) {
                        errorDiv.textContent = errors.join(', ');
                    }
                }
            }
        }
    })
    .catch(error => {
        console.error('‚ùå Erro ao salvar aluno:', error);
        alert('Erro ao salvar aluno.');
    });
}

function salvarEdicaoAluno() {
    console.log('üíæ Salvando edi√ß√£o do aluno...');
    
    const id = document.getElementById('editar-aluno-id').value;
    const form = document.getElementById('formEditarAluno');
    const formData = new FormData(form);
    
    fetch(`/alunos/${id}/editar`, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.redirected) {
            window.location.href = response.url;
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Fechar o modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editarAlunoModal'));
            modal.hide();
            
            // Recarregar a p√°gina
            window.location.reload();
        } else {
            // Exibir erros de valida√ß√£o
            if (data.errors) {
                for (const [field, errors] of Object.entries(data.errors)) {
                    const errorDiv = document.getElementById(`editar-erro-${field}`);
                    if (errorDiv) {
                        errorDiv.textContent = errors.join(', ');
                    }
                }
            }
        }
    })
    .catch(error => {
        console.error('‚ùå Erro ao salvar edi√ß√£o:', error);
        alert('Erro ao salvar edi√ß√£o.');
    });
}

function confirmarExclusaoAluno() {
    console.log(`üóëÔ∏è Confirmando exclus√£o do aluno ID: ${alunoIdParaExcluir}`);
    
    if (!alunoIdParaExcluir) {
        alert('ID do aluno n√£o encontrado.');
        return;
    }
    
    // Obter o CSRF token do formul√°rio de novo aluno
    const csrfToken = document.querySelector('#formNovoAluno input[name="csrf_token"]').value;
    
    fetch(`/alunos/${alunoIdParaExcluir}/excluir`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => {
        if (response.redirected) {
            window.location.href = response.url;
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Fechar o modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('excluirAlunoModal'));
            modal.hide();
            
            // Recarregar a p√°gina
            window.location.reload();
        } else {
            alert('Erro ao excluir aluno.');
        }
    })
    .catch(error => {
        console.error('‚ùå Erro ao excluir aluno:', error);
        alert('Erro ao excluir aluno.');
    });
}
</script>
{% endblock %}